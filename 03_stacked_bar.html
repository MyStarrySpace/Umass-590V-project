<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>D3: Stack layout stacked bar chart</title>
		<script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script>
		<style type="text/css">
			/* No style rules here yet */
		</style>
	</head>
	<body>
		<h3>
			Effect of different factors on willingness to discuss mental health issues
		</h3>
		<script type="text/javascript">

			//Original data
			var dataset = [
				{ apples: 5, oranges: 10, grapes: 22, factor: "a"},
				{ apples: 4, oranges: 12, grapes: 28, factor: "b"},
				{ apples: 2, oranges: 19, grapes: 32, factor: "c"},
				{ apples: 7, oranges: 23, grapes: 35, factor: "d"},
				{ apples: 23, oranges: 17, grapes: 43, factor: "e"}
			];

			//Width and height
			var w = 600;
			var h = 80 * dataset.length;

			//Set up stack method
			var stack = d3.stack()
						  .keys([ "apples", "oranges", "grapes"]);

			//Method to onvert dataset to percentages
			var toPercent = function(dataset, keys){
				output = [];
				for (item in dataset){
					obj = {};
					total = 0;
					for (key of keys){
						total += dataset[item][key];
					}
					for (key of keys){
						obj[key] = dataset[item][key] / total * 100;
					}
					output[item] = obj;
				}
				return output;
			};


			//Data, stacked
			var series = stack(toPercent(dataset, ["apples", "oranges", "grapes"]));
			
			//Set up scales
			var xScale = d3.scaleLinear()
				.domain([0,				
					d3.max(dataset, function(d) {
						return d.apples + d.oranges + d.grapes;
					})
				])
				.range([0, h]);
			var yScale = d3.scaleBand()
				.domain(d3.range(dataset.length))
				.range([0, h])
				.padding(0.2);
				
			// Set up colors
			var colors = d3.scaleOrdinal(dataset).range(["#309603", "#FFF020", "#FB0017"]);
			var colors2 = d3.scaleOrdinal(dataset).range(["#B1F68A", "#FFFC80", "#FD97AC"]);
		
			//Create SVG element
			var svg = d3.select("body")
						.append("svg")
						.attr("width", w)
						.attr("height", h);

			// Add a group for each row of data
			var groups = svg.selectAll("g")
				.data(series)
				.enter()
				.append("g")
				.style("fill", function(d, i) {
					return colors(i);
				})
				.attr("transform", "translate(50,10)");

			// Create feature labels (y axis)
			var scale = d3.scaleOrdinal()
                .domain([d3.min(dataset), d3.max(dataset)])
                .range(Array.from({length: dataset.length},(v,k)=>k*70 + 20));



            var y_axis = d3.axisLeft()
                  .scale(scale);

            scale.domain(dataset.map(function(d) { 
            	console.log(d.factor);
            	return d.factor; }));

			svg.append("g")
				.attr("class", "x axis")
            	.attr("transform", "translate(50,10)")
            	.call(y_axis)
            	.selectAll("text");
			
				// console.log(series)
			// Add a rect for each data value
			var rects = groups.selectAll("rect")
				.data(function(d) { 
					console.log(d)
					console.log(d.index)
					return d; })
				.enter()
				.append("rect")
				.attr("y", function(d, i) {
					return yScale(i);
				})
				.attr("x", function(d) {
					return xScale(d[0]);
				})
				.attr("width", function(d) {
					return xScale(d[1]) - xScale(d[0]);
				})
				.attr("height", yScale.bandwidth());

			// Add text
			var bar_text = groups.selectAll(".text")
				.data(function(d) { 
					return d; })
				.enter()
				.append("text")
				.attr("class","label")
				.attr("x", (function(d) { return xScale(d[0]) + 5; }))
				.attr("y", (function(d, i) { return yScale(i) + 15; }))
				.attr("dy", ".75em")
				.text(function(d) { return Math.round(d[1] - d[0]) + "%"; })
				.style("fill", function(d, i) {
					return "#000000";
				});
			console.log("SERIES");
			console.log(series);
						
		</script>
	</body>
</html>